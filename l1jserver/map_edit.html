<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÑ™ÂåñÁâàÂú∞ÂúñÁ∑®ËºØÂô®</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        #controls {
            background: #2c3e50;
            color: white;
            padding: 10px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        button {
            padding: 8px 15px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background: #3498db;
            color: white;
            font-weight: bold;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }

        input[type="number"] {
            width: 80px;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        input[type="file"] {
            display: none;
        }

        label {
            font-weight: bold;
        }

        #container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #canvasContainer {
            flex: 1;
            position: relative;
            overflow: auto;
            background: #34495e;
        }

        #mapCanvas {
            display: block;
            cursor: crosshair;
            image-rendering: pixelated;
        }

        #selectionCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            image-rendering: pixelated;
        }

        #coordinateInfo {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: monospace;
            pointer-events: none;
            font-size: 14px;
        }

        #pageInfo {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(52, 152, 219, 0.95);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            font-weight: bold;
            pointer-events: none;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #pageControls {
            position: absolute;
            top: 50px;
            right: 10px;
            background: rgba(44, 62, 80, 0.95);
            padding: 10px;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .page-nav {
            display: flex;
            gap: 5px;
            align-items: center;
            color: white;
            font-size: 12px;
        }

        .page-nav button {
            padding: 5px 10px;
            font-size: 12px;
        }

        .tool-button {
            padding: 8px 15px;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .tool-button.active {
            border-color: #e74c3c;
            background: #e74c3c;
        }

        #stats {
            background: #27ae60;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }

        #brushInfo {
            background: #9b59b6;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="controls">
        <div class="control-group">
            <button onclick="document.getElementById('fileInput').click()">üìÅ ËºâÂÖ•Âú∞Âúñ</button>
            <input type="file" id="fileInput" accept=".csv,.txt">
        </div>

        <div class="control-group">
            <button onclick="saveCSV()">üíæ ÂÑ≤Â≠òCSV</button>
        </div>

        <div class="control-group">
            <label>Â∑•ÂÖ∑:</label>
            <button class="tool-button active" onclick="setTool('pen')" id="penTool">‚úèÔ∏è Á≠ÜÂà∑</button>
            <button class="tool-button" onclick="setTool('select')" id="selectTool">üî≤ Ê°ÜÈÅ∏</button>
            <button class="tool-button" onclick="setTool('fill')" id="fillTool">ü™£ Â°´ÂÖÖ</button>
        </div>

        <div class="control-group">
            <label>Â°´ÂÖÖÂÄº:</label>
            <input type="number" id="fillValue" value="0" min="0" max="255">
        </div>

        <div class="control-group">
            <button onclick="fillSelection()" id="fillSelectionBtn" disabled>üì¶ Â°´ÂÖÖÈÅ∏ÂçÄ</button>
            <button onclick="clearSelection()" id="clearSelectionBtn" disabled>‚ùå Ê∏ÖÈô§ÈÅ∏ÂçÄ</button>
        </div>

        <div class="control-group">
            <label>È°ØÁ§∫Â§ßÂ∞è:</label>
            <button onclick="setViewSize(128)">128</button>
            <button onclick="setViewSize(256)">256</button>
            <button onclick="setViewSize(512)">512</button>
            <button onclick="setViewSize(1024)">1024</button>
            <button onclick="setViewSize(2048)">2048</button>
            <span id="viewSize">128x128</span>
        </div>

        <div id="stats">
            Âú∞ÂúñÂ§ßÂ∞è: <span id="mapSize">0x0</span>
        </div>

        <div id="brushInfo">
            Á≠ÜÂà∑Â§ßÂ∞è: <span id="brushSize">1x1</span>
        </div>
    </div>

    <div id="container">
        <div id="canvasContainer">
            <canvas id="mapCanvas"></canvas>
            <canvas id="selectionCanvas"></canvas>
            
            <div id="pageInfo">
                È°ØÁ§∫ÁØÑÂúç: X(0-128) Y(0-128)
            </div>
            
            <div id="pageControls">
                <div class="page-nav">
                    <button onclick="changePage(-1, 0)">‚¨ÖÔ∏è</button>
                    <span>È†Å X: <span id="pageX">1</span>/<span id="totalPagesX">1</span></span>
                    <button onclick="changePage(1, 0)">‚û°Ô∏è</button>
                </div>
                <div class="page-nav">
                    <button onclick="changePage(0, -1)">‚¨ÜÔ∏è</button>
                    <span>È†Å Y: <span id="pageY">1</span>/<span id="totalPagesY">1</span></span>
                    <button onclick="changePage(0, 1)">‚¨áÔ∏è</button>
                </div>
            </div>
            
            <div id="coordinateInfo">X: 0, Y: 0</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('mapCanvas');
        const ctx = canvas.getContext('2d', { alpha: false, willReadFrequently: true });
        const selectionCanvas = document.getElementById('selectionCanvas');
        const selectionCtx = selectionCanvas.getContext('2d');

        let mapData = [];
        let mapWidth = 0;
        let mapHeight = 0;
        let currentTool = 'pen';
        let isDrawing = false;
        let pixelSize = 4; // ÊØèÂÄãÂú∞ÂúñÊ†ºÂ≠êÁöÑÈ°ØÁ§∫ÂÉèÁ¥†Â§ßÂ∞è
        let viewSize = 128; // Ë¶ñÁ™óÈ°ØÁ§∫ÁöÑÂú∞ÂúñÊ†ºÂ≠êÊï∏Èáè
        let brushRadius = 0; // Á≠ÜÂà∑ÂçäÂæëÔºà0 = 1x1, 1 = 3x3, 2 = 5x5Ôºâ
        
        // ÂàÜÈ†ÅÁõ∏Èóú
        const PAGE_SIZE = 128;
        let currentPageX = 0;
        let currentPageY = 0;
        let totalPagesX = 1;
        let totalPagesY = 1;

        // Ê°ÜÈÅ∏Áõ∏Èóú
        let selectionStart = null;
        let selectionEnd = null;
        let selectedRegion = null;

        // È°èËâ≤Êò†Â∞Ñ (ÂÑ™ÂåñÁâà - ‰ΩøÁî®Á∑©Â≠ò)
        const colorCache = new Map();
        function getColor(value) {
            if (colorCache.has(value)) return colorCache.get(value);
            
            let color;
            if (value === 0) {
                color = '#FFFFFF';  // ÁôΩËâ≤
            } else if (value === 1) {
                color = '#808080';  // ÁÅ∞Ëâ≤
            } else if (value >= 2 && value <= 10) {
                color = '#ADD8E6';  // Ê∑∫ËóçËâ≤
            } else if (value >= 11 && value <= 20) {
                color = '#90EE90';  // Ê∑∫Á∂†Ëâ≤
            } else {
                color = '#FFB6C1';  // Ê∑∫Á¥ÖËâ≤
            }
            
            colorCache.set(value, color);
            return color;
        }

        // Ê†πÊìöË¶ñÁ™óÂ§ßÂ∞èË®àÁÆóÁ≠ÜÂà∑ÂçäÂæë
        function calculateBrushRadius(viewSize) {
            // 128x128 -> ÂçäÂæë0 (1x1)
            // 256x256 -> ÂçäÂæë1 (3x3)
            // 512x512 -> ÂçäÂæë2 (5x5)
            // 1024x1024 -> ÂçäÂæë4 (9x9)
            // 2048x2048 -> ÂçäÂæë8 (17x17)
            if (viewSize <= 128) return 0;
            if (viewSize <= 256) return 1;
            if (viewSize <= 512) return 2;
            if (viewSize <= 1024) return 4;
            return 8;
        }

        // Êõ¥Êñ∞Á≠ÜÂà∑Â§ßÂ∞èÈ°ØÁ§∫
        function updateBrushInfo() {
            const size = brushRadius * 2 + 1;
            document.getElementById('brushSize').textContent = `${size}x${size}`;
        }

        // Ë®≠ÁΩÆÂ∑•ÂÖ∑
        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(tool + 'Tool').classList.add('active');
            
            if (tool !== 'select') {
                clearSelection();
            }
        }

        // Ë®≠ÁΩÆË¶ñÁ™óÂ§ßÂ∞è
        function setViewSize(size) {
            viewSize = size;
            pixelSize = Math.max(1, Math.floor(512 / size)); // Ê†πÊìöË¶ñÁ™óÂ§ßÂ∞èË™øÊï¥ÂÉèÁ¥†Â§ßÂ∞è
            brushRadius = calculateBrushRadius(size); // Ë®àÁÆóÁ≠ÜÂà∑ÂçäÂæë
            document.getElementById('viewSize').textContent = `${size}x${size}`;
            updateBrushInfo();
            if (mapData.length > 0) {
                renderFullMap();
            }
        }

        // ËºâÂÖ•Âú∞ÂúñÊ™îÊ°à (ÊîØÊåÅ CSV Âíå TXT)
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const content = event.target.result;
                parseMapFile(content);
            };
            reader.readAsText(file);
        });

        function parseMapFile(content) {
            const lines = content.trim().split('\n');
            mapHeight = lines.length;
            
            // Ê™¢Ê∏¨ÂàÜÈöîÁ¨¶ (ÊîØÊåÅÈÄóËôü„ÄÅÁ©∫Ê†º„ÄÅÂà∂Ë°®Á¨¶)
            let delimiter = ',';
            if (lines[0].includes('\t')) {
                delimiter = '\t';
            } else if (lines[0].includes(' ') && !lines[0].includes(',')) {
                delimiter = ' ';
            }
            
            mapWidth = lines[0].split(delimiter).filter(v => v.trim()).length;
            mapData = new Uint8Array(mapWidth * mapHeight);
            
            for (let y = 0; y < mapHeight; y++) {
                const values = lines[y].split(delimiter).filter(v => v.trim());
                for (let x = 0; x < mapWidth && x < values.length; x++) {
                    mapData[y * mapWidth + x] = parseInt(values[x]) || 0;
                }
            }

            // Ë®àÁÆóÁ∏ΩÈ†ÅÊï∏
            totalPagesX = Math.ceil(mapWidth / PAGE_SIZE);
            totalPagesY = Math.ceil(mapHeight / PAGE_SIZE);
            currentPageX = 0;
            currentPageY = 0;

            updateStats();
            updateBrushInfo();
            renderFullMap();
            updatePageInfo();
        }

        function updateStats() {
            document.getElementById('mapSize').textContent = `${mapWidth}x${mapHeight}`;
        }

        // Ê∏≤ÊüìÂÆåÊï¥Âú∞Âúñ (ÂÑ™ÂåñÁâà - ÊîØÊåÅÂàÜÈ†ÅÈ°ØÁ§∫)
        let offscreenCanvas = null;
        let offscreenCtx = null;

        function renderFullMap() {
            // Ë®àÁÆóÁï∂ÂâçÈ†ÅÈù¢ÁöÑÈ°ØÁ§∫ÁØÑÂúç
            const startX = currentPageX * PAGE_SIZE;
            const startY = currentPageY * PAGE_SIZE;
            const endX = Math.min(startX + viewSize, mapWidth);
            const endY = Math.min(startY + viewSize, mapHeight);
            const renderWidth = endX - startX;
            const renderHeight = endY - startY;

            canvas.width = renderWidth * pixelSize;
            canvas.height = renderHeight * pixelSize;
            selectionCanvas.width = canvas.width;
            selectionCanvas.height = canvas.height;

            // ‰ΩøÁî®Èõ¢Â±ècanvasÊèêÂçáÊÄßËÉΩ
            if (!offscreenCanvas || offscreenCanvas.width !== renderWidth || offscreenCanvas.height !== renderHeight) {
                offscreenCanvas = document.createElement('canvas');
                offscreenCanvas.width = renderWidth;
                offscreenCanvas.height = renderHeight;
                offscreenCtx = offscreenCanvas.getContext('2d', { alpha: false });
            }

            const imageData = offscreenCtx.createImageData(renderWidth, renderHeight);
            const data = imageData.data;

            // Âè™Ê∏≤ÊüìÁï∂ÂâçÈ†ÅÈù¢ÁöÑÊï∏Êìö
            for (let y = 0; y < renderHeight; y++) {
                for (let x = 0; x < renderWidth; x++) {
                    const mapX = startX + x;
                    const mapY = startY + y;
                    const value = mapData[mapY * mapWidth + mapX];
                    const color = getColor(value);
                    const rgb = hexToRgb(color);
                    
                    const idx = (y * renderWidth + x) * 4;
                    data[idx] = rgb.r;
                    data[idx + 1] = rgb.g;
                    data[idx + 2] = rgb.b;
                    data[idx + 3] = 255;
                }
            }

            offscreenCtx.putImageData(imageData, 0, 0);
            
            // Á∏ÆÊîæÊ∏≤Êüì
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(
                offscreenCanvas, 
                0, 0, renderWidth, renderHeight,
                0, 0, renderWidth * pixelSize, renderHeight * pixelSize
            );

            // ÈáçÁπ™ÈÅ∏ÂçÄ
            if (selectedRegion) {
                drawSelection();
            }
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : {r: 0, g: 0, b: 0};
        }

        // ÂàÜÈ†ÅÊéßÂà∂
        function changePage(dx, dy) {
            currentPageX = Math.max(0, Math.min(totalPagesX - 1, currentPageX + dx));
            currentPageY = Math.max(0, Math.min(totalPagesY - 1, currentPageY + dy));
            
            // Ê∏ÖÈô§Á∑©Â≠òÔºåÂº∑Âà∂ÈáçÊñ∞ÂâµÂª∫Èõ¢Â±ècanvas
            offscreenCanvas = null;
            
            renderFullMap();
            updatePageInfo();
        }

        function updatePageInfo() {
            const startX = currentPageX * PAGE_SIZE;
            const startY = currentPageY * PAGE_SIZE;
            const endX = Math.min(startX + viewSize, mapWidth);
            const endY = Math.min(startY + viewSize, mapHeight);

            document.getElementById('pageInfo').textContent = 
                `È°ØÁ§∫ÁØÑÂúç: X(${startX}-${endX}) Y(${startY}-${endY})`;
            document.getElementById('pageX').textContent = currentPageX + 1;
            document.getElementById('pageY').textContent = currentPageY + 1;
            document.getElementById('totalPagesX').textContent = totalPagesX;
            document.getElementById('totalPagesY').textContent = totalPagesY;
        }

        // Áπ™Âúñ‰∫ã‰ª∂
        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            handleMouseDown(e);
        });

        canvas.addEventListener('mousemove', (e) => {
            updateCoordinateInfo(e);
            if (isDrawing) {
                handleMouseMove(e);
            }
        });

        canvas.addEventListener('mouseup', (e) => {
            handleMouseUp(e);
            isDrawing = false;
        });

        canvas.addEventListener('mouseleave', () => {
            isDrawing = false;
        });

        function getCanvasCoords(e) {
            const rect = canvas.getBoundingClientRect();
            const relativeX = Math.floor((e.clientX - rect.left) / pixelSize);
            const relativeY = Math.floor((e.clientY - rect.top) / pixelSize);
            
            // ËΩâÊèõÁÇ∫ÁµïÂ∞çÂú∞ÂúñÂùêÊ®ô
            const x = currentPageX * PAGE_SIZE + relativeX;
            const y = currentPageY * PAGE_SIZE + relativeY;
            
            return { x, y, relativeX, relativeY };
        }

        function handleMouseDown(e) {
            const { x, y } = getCanvasCoords(e);
            
            if (currentTool === 'select') {
                selectionStart = { x, y };
                selectionEnd = { x, y };
            } else if (currentTool === 'pen') {
                drawPixel(x, y);
            } else if (currentTool === 'fill') {
                floodFill(x, y);
            }
        }

        function handleMouseMove(e) {
            const { x, y } = getCanvasCoords(e);
            
            if (currentTool === 'select' && selectionStart) {
                selectionEnd = { x, y };
                drawSelection();
            } else if (currentTool === 'pen') {
                drawPixel(x, y);
            }
        }

        function handleMouseUp(e) {
            if (currentTool === 'select' && selectionStart && selectionEnd) {
                const minX = Math.min(selectionStart.x, selectionEnd.x);
                const maxX = Math.max(selectionStart.x, selectionEnd.x);
                const minY = Math.min(selectionStart.y, selectionEnd.y);
                const maxY = Math.max(selectionStart.y, selectionEnd.y);
                
                selectedRegion = { minX, maxX, minY, maxY };
                document.getElementById('fillSelectionBtn').disabled = false;
                document.getElementById('clearSelectionBtn').disabled = false;
            }
        }

        function drawSelection() {
            if (!selectionStart || !selectionEnd) return;
            
            selectionCtx.clearRect(0, 0, selectionCanvas.width, selectionCanvas.height);
            
            const minX = Math.min(selectionStart.x, selectionEnd.x);
            const maxX = Math.max(selectionStart.x, selectionEnd.x);
            const minY = Math.min(selectionStart.y, selectionEnd.y);
            const maxY = Math.max(selectionStart.y, selectionEnd.y);
            
            // ËΩâÊèõÁÇ∫Áõ∏Â∞çÈ†ÅÈù¢ÂùêÊ®ô
            const pageStartX = currentPageX * PAGE_SIZE;
            const pageStartY = currentPageY * PAGE_SIZE;
            const relMinX = minX - pageStartX;
            const relMinY = minY - pageStartY;
            const relMaxX = maxX - pageStartX;
            const relMaxY = maxY - pageStartY;
            
            selectionCtx.strokeStyle = '#00ff00';
            selectionCtx.lineWidth = 2;
            selectionCtx.setLineDash([5, 5]);
            selectionCtx.strokeRect(
                relMinX * pixelSize,
                relMinY * pixelSize,
                (relMaxX - relMinX + 1) * pixelSize,
                (relMaxY - relMinY + 1) * pixelSize
            );
        }

        function fillSelection() {
            if (!selectedRegion) return;
            
            const fillValue = parseInt(document.getElementById('fillValue').value);
            const { minX, maxX, minY, maxY } = selectedRegion;
            
            for (let y = minY; y <= maxY; y++) {
                for (let x = minX; x <= maxX; x++) {
                    if (x >= 0 && x < mapWidth && y >= 0 && y < mapHeight) {
                        mapData[y * mapWidth + x] = fillValue;
                    }
                }
            }
            
            renderFullMap();
        }

        function clearSelection() {
            selectionStart = null;
            selectionEnd = null;
            selectedRegion = null;
            selectionCtx.clearRect(0, 0, selectionCanvas.width, selectionCanvas.height);
            document.getElementById('fillSelectionBtn').disabled = true;
            document.getElementById('clearSelectionBtn').disabled = true;
        }

        // ‰øÆÊîπÂæåÁöÑ drawPixel ÂáΩÊï∏ - ÊîØÊè¥Á≠ÜÂà∑Â§ßÂ∞è
        function drawPixel(centerX, centerY) {
            if (centerX < 0 || centerX >= mapWidth || centerY < 0 || centerY >= mapHeight) return;
            
            const fillValue = parseInt(document.getElementById('fillValue').value);
            const pageStartX = currentPageX * PAGE_SIZE;
            const pageStartY = currentPageY * PAGE_SIZE;
            
            // Ê†πÊìöÁ≠ÜÂà∑ÂçäÂæëÁπ™Ë£ΩÂ§öÂÄãÊ†ºÂ≠ê
            for (let dy = -brushRadius; dy <= brushRadius; dy++) {
                for (let dx = -brushRadius; dx <= brushRadius; dx++) {
                    const x = centerX + dx;
                    const y = centerY + dy;
                    
                    // Ê™¢Êü•ÊòØÂê¶Âú®Âú∞ÂúñÁØÑÂúçÂÖß
                    if (x >= 0 && x < mapWidth && y >= 0 && y < mapHeight) {
                        mapData[y * mapWidth + x] = fillValue;
                        
                        // Ë®àÁÆóÁõ∏Â∞çÈ†ÅÈù¢ÂùêÊ®ô‰∏¶Áπ™Ë£Ω
                        const relX = x - pageStartX;
                        const relY = y - pageStartY;
                        
                        // Âè™Áπ™Ë£ΩÂú®Áï∂ÂâçË¶ñÁ™óÂÖßÁöÑÊ†ºÂ≠ê
                        if (relX >= 0 && relX < viewSize && relY >= 0 && relY < viewSize) {
                            ctx.fillStyle = getColor(fillValue);
                            ctx.fillRect(relX * pixelSize, relY * pixelSize, pixelSize, pixelSize);
                        }
                    }
                }
            }
        }

        function floodFill(startX, startY) {
            const fillValue = parseInt(document.getElementById('fillValue').value);
            const targetValue = mapData[startY * mapWidth + startX];
            
            if (targetValue === fillValue) return;

            const stack = [{x: startX, y: startY}];
            const visited = new Set();

            while (stack.length > 0) {
                const {x, y} = stack.pop();
                const key = `${x},${y}`;
                
                if (visited.has(key)) continue;
                if (x < 0 || x >= mapWidth || y < 0 || y >= mapHeight) continue;
                if (mapData[y * mapWidth + x] !== targetValue) continue;

                visited.add(key);
                mapData[y * mapWidth + x] = fillValue;

                stack.push({x: x + 1, y});
                stack.push({x: x - 1, y});
                stack.push({x, y: y + 1});
                stack.push({x, y: y - 1});
            }

            renderFullMap();
        }

        function updateCoordinateInfo(e) {
            const { x, y } = getCanvasCoords(e);
            if (x >= 0 && x < mapWidth && y >= 0 && y < mapHeight) {
                document.getElementById('coordinateInfo').textContent = 
                    `X: ${x}, Y: ${y} | ÂÄº: ${mapData[y * mapWidth + x] || 0}`;
            }
        }

        // ÂÑ≤Â≠òCSV
        function saveCSV() {
            if (mapData.length === 0) {
                alert('Ê≤íÊúâÂú∞ÂúñË≥áÊñôÂèØ‰ª•ÂÑ≤Â≠ò');
                return;
            }

            let csv = '';
            for (let y = 0; y < mapHeight; y++) {
                const row = [];
                for (let x = 0; x < mapWidth; x++) {
                    row.push(mapData[y * mapWidth + x]);
                }
                csv += row.join(',') + '\n';
            }

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'map_edited.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>